name: ğŸš€ Build Sideload IPA

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - simulator

jobs:
  build-sideload-ipa:
    name: ğŸ“± Build Sideloadable IPA
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0'
    
    - name: ğŸ› ï¸ Install Tools
      run: |
        brew install xcodegen
        echo "âœ… Tools installed"
    
    - name: ğŸ“± Generate Project
      run: |
        xcodegen generate
        echo "âœ… Project generated"
    
    - name: ğŸ—ï¸ Build for Device (Unsigned)
      if: inputs.build_type == 'development'
      timeout-minutes: 15
      run: |
        echo "ğŸš€ Building unsigned IPA for sideloading..."
        
        # Clean any previous builds
        echo "ğŸ§¹ Cleaning previous builds..."
        rm -rf ./DerivedData
        rm -rf SketchAI.xcodeproj
        
        # Regenerate project to ensure fresh state
        echo "ğŸ“± Regenerating Xcode project..."
        xcodegen generate
        
        # Kill any lingering simulator processes that could cause runtime conflicts
        echo "ğŸ”§ Killing lingering simulator processes..."
        sudo killall -9 com.apple.CoreSimulator.CoreSimulatorService 2>/dev/null || true
        
        # Completely disable simulator support in Xcode
        echo "ğŸ”§ Disabling simulator support completely..."
        sudo xcrun simctl shutdown all 2>/dev/null || true
        sudo xcrun simctl erase all 2>/dev/null || true
        
        # Remove simulator runtimes to prevent conflicts
        echo "ğŸ”§ Removing simulator runtimes..."
        sudo rm -rf /Library/Developer/CoreSimulator/Profiles/Runtimes/* 2>/dev/null || true
        
        # Apply asset catalog fixes for device-only build
        echo "ğŸ”§ Applying asset catalog compilation fixes..."
        export ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO
        export ASSETCATALOG_COMPILER_OPTIMIZATION=space
        export ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS=NO
        export ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOLS=NO
        export ASSETCATALOG_COMPILER_APPICON_NAME=AppIcon
        export ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME=AccentColor
        export ASSETCATALOG_COMPILER_SKIP_VALIDATION=NO
        # Force device-only platform
        export SUPPORTED_PLATFORMS=iphoneos
        export TARGETED_DEVICE_FAMILY=1,2
        # Force device-only compilation
        export ONLY_ACTIVE_ARCH=NO
        export VALIDATE_PRODUCT=NO
        export SKIP_INSTALL=NO
        
        # Verify project generation
        if [ ! -f "SketchAI.xcodeproj/project.pbxproj" ]; then
          echo "âŒ Project generation failed"
          exit 1
        fi
        
        # Build without code signing with verbose output
        echo "ğŸ”¨ Starting build process..."
        xcodebuild clean \
          -project SketchAI.xcodeproj \
          -scheme SketchAI \
          -configuration Debug
        
        # Force device-only asset catalog compilation
        echo "ğŸ”§ Forcing device-only asset catalog compilation..."
        export ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO
        export ASSETCATALOG_COMPILER_OPTIMIZATION=space
        export ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS=NO
        export ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOLS=NO
        export ASSETCATALOG_COMPILER_APPICON_NAME=AppIcon
        export ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME=AccentColor
        export ASSETCATALOG_COMPILER_SKIP_VALIDATION=NO
        export SUPPORTED_PLATFORMS=iphoneos
        export TARGETED_DEVICE_FAMILY=1,2
        export ONLY_ACTIVE_ARCH=NO
        export VALIDATE_PRODUCT=NO
        export SKIP_INSTALL=NO
        
        xcodebuild build \
          -project SketchAI.xcodeproj \
          -scheme SketchAI \
          -configuration Debug \
          -destination 'generic/platform=iOS' \
          -derivedDataPath ./DerivedData \
          -parallelizeTargets \
          -jobs 4 \
          SWIFT_COMPILATION_MODE=wholemodule \
          SWIFT_OPTIMIZATION_LEVEL=-Onone \
          GCC_OPTIMIZATION_LEVEL=0 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE="" \
          ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO \
          ASSETCATALOG_COMPILER_OPTIMIZATION=space \
          ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS=NO \
          ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOLS=NO \
          ASSETCATALOG_COMPILER_APPICON_NAME=AppIcon \
          ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME=AccentColor \
          SUPPORTED_PLATFORMS="iphoneos" \
          VALID_ARCHS="arm64" \
          ARCHS="arm64" \
          TARGETED_DEVICE_FAMILY="1,2" \
          IPHONEOS_DEPLOYMENT_TARGET=16.0 \
          EXCLUDED_ARCHS[sdk=iphonesimulator*]="arm64" \
          ONLY_ACTIVE_ARCH=NO \
          VALIDATE_PRODUCT=NO \
          SKIP_INSTALL=NO \
          ASSETCATALOG_COMPILER_SKIP_VALIDATION=NO \
          ASSETCATALOG_COMPILER_APPICON_NAME=AppIcon \
          ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME=AccentColor \
          TARGETED_DEVICE_FAMILY="1,2" \
          SUPPORTED_PLATFORMS="iphoneos" \
          ONLY_ACTIVE_ARCH=NO \
          VALIDATE_PRODUCT=NO \
          SKIP_INSTALL=NO \
          ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=NO \
          ASSETCATALOG_COMPILER_OPTIMIZATION=space \
          ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS=NO \
          ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOLS=NO \
          ASSETCATALOG_COMPILER_SKIP_VALIDATION=NO \
          ASSETCATALOG_COMPILER_APPICON_NAME=AppIcon \
          ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME=AccentColor \
          2>&1 | tee sideload_build_output.log
        
        # Analyze build output for errors
        echo "ğŸ“Š Analyzing build output..."
        
        # Count errors and warnings
        TOTAL_ERRORS=$(grep -c "error:" sideload_build_output.log || echo "0")
        TOTAL_WARNINGS=$(grep -c "warning:" sideload_build_output.log || echo "0")
        
        echo ""
        echo "ğŸ“Š BUILD STATISTICS:"
        echo "  Total Errors: $TOTAL_ERRORS"
        echo "  Total Warnings: $TOTAL_WARNINGS"
        
        # Show all errors if any
        if [ $TOTAL_ERRORS -gt 0 ]; then
          echo ""
          echo "ğŸ”´ ALL COMPILATION ERRORS:"
          echo "=========================="
          grep -n "error:" sideload_build_output.log
          echo ""
          echo "âŒ Build failed with $TOTAL_ERRORS errors"
          exit 1
        fi
        
        echo "âœ… Build completed successfully with no errors!"
    
    - name: ğŸ—ï¸ Build for Simulator  
      if: inputs.build_type == 'simulator'
      run: |
        echo "ğŸš€ Building for iOS Simulator..."
        
        xcodebuild \
          -project SketchAI.xcodeproj \
          -scheme SketchAI \
          -configuration Debug \
          -destination 'generic/platform=iOS Simulator' \
          -derivedDataPath ./DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          build
        
        echo "âœ… Simulator build completed"
    
    - name: ğŸ“¦ Create IPA Package
      if: inputs.build_type == 'development'
      run: |
        echo "ğŸ“¦ Creating IPA file..."
        
        # Find the built .app file
        APP_PATH=$(find ./DerivedData -name "SketchAI.app" -type d | head -1)
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ SketchAI.app not found!"
          find ./DerivedData -name "*.app" -type d
          exit 1
        fi
        
        echo "Found app at: $APP_PATH"
        
        # Create IPA structure
        mkdir -p Payload
        cp -R "$APP_PATH" Payload/SketchAI.app
        
        # Create IPA file
        zip -r SketchAI-Sideload.ipa Payload/
        
        # Verify IPA
        if [ -f "SketchAI-Sideload.ipa" ]; then
          echo "âœ… IPA created successfully!"
          echo "File size: $(ls -lh SketchAI-Sideload.ipa | awk '{print $5}')"
        else
          echo "âŒ IPA creation failed!"
          exit 1
        fi
    
    - name: ğŸ“¦ Package Simulator App
      if: inputs.build_type == 'simulator'
      run: |
        echo "ğŸ“¦ Packaging Simulator app..."
        
        APP_PATH=$(find ./DerivedData -name "SketchAI.app" -type d | head -1)
        
        if [ -n "$APP_PATH" ]; then
          zip -r SketchAI-Simulator.zip "$APP_PATH"
          echo "âœ… Simulator app packaged"
        fi
    
    - name: ğŸ“¤ Upload IPA
      if: inputs.build_type == 'development'
      uses: actions/upload-artifact@v4
      with:
        name: SketchAI-Sideload-IPA
        path: SketchAI-Sideload.ipa
        retention-days: 30
    
    - name: ğŸ“¤ Upload Simulator App
      if: inputs.build_type == 'simulator'
      uses: actions/upload-artifact@v4
      with:
        name: SketchAI-Simulator-App
        path: SketchAI-Simulator.zip
        retention-days: 30
    
    - name: ğŸ“‹ Download Instructions
      run: |
        echo ""
        echo "ğŸ‰ BUILD COMPLETED SUCCESSFULLY!"
        echo "================================="
        echo ""
        
        if [ "${{ inputs.build_type }}" == "development" ]; then
          echo "ğŸ“± DEVICE INSTALLATION (Sideloading):"
          echo "-------------------------------------"
          echo "1. ğŸ“¥ Go to this workflow's summary page"
          echo "2. ğŸ“‚ Download 'SketchAI-Sideload-IPA' from Artifacts"
          echo "3. ğŸ“± Install using one of these methods:"
          echo ""
          echo "   ğŸŸ¢ AltStore (Easiest - Free):"
          echo "   â€¢ Install AltStore on your device: altstore.io"
          echo "   â€¢ Open AltStore â†’ '+' â†’ Browse â†’ Select IPA"
          echo ""
          echo "   ğŸŸ¢ Sideloadly (Free with watermark):"
          echo "   â€¢ Download Sideloadly: sideloadly.io"
          echo "   â€¢ Connect device â†’ drag IPA to install"
          echo ""
          echo "   ğŸŸ¢ TrollStore (iOS 14.0-16.6.1):"
          echo "   â€¢ If you have TrollStore, directly install IPA"
          echo ""
          echo "   ğŸ”µ Xcode (Mac required):"
          echo "   â€¢ Xcode â†’ Window â†’ Devices â†’ Drag IPA"
          echo ""
        else
          echo "ğŸ–¥ï¸ SIMULATOR INSTALLATION:"
          echo "-------------------------"
          echo "1. ğŸ“¥ Download 'SketchAI-Simulator-App' from Artifacts"
          echo "2. ğŸ“‚ Extract the ZIP file"
          echo "3. ğŸ–¥ï¸ Drag SketchAI.app to iOS Simulator"
          echo ""
        fi
        
        echo "âš ï¸  IMPORTANT NOTES:"
        echo "â€¢ This is an unsigned build for testing only"
        echo "â€¢ You may need to trust the developer certificate"
        echo "â€¢ App will expire after 7 days (re-install if needed)"
        echo ""
        echo "ğŸ”§ TROUBLESHOOTING:"
        echo "â€¢ If app won't open: Settings â†’ General â†’ VPN & Device Management â†’ Trust"
        echo "â€¢ If installation fails: Try different sideloading tool"
        echo ""
        echo "ğŸ¨ Ready to test your SketchAI drawing app! ğŸ¨"
